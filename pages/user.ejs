<!DOCTYPE html>
<html lang="en">

<%- include('../partials/head.ejs', {page: user.name, vue: true, profile:true, username:user.name, userid:user._id}); %>

<body class='bg-gray-100'>
    <%- include('../partials/nav.ejs', {active: "user_"+user.name, user:loggedInUser, loggedIn}); %>

    <div id='data' class='hidden'>
        <% if(loggedIn){ %>
            <input type="hidden" id="loggedInUserID" value="<%= loggedInUser._id %>">
        <% } %>
        <input type="hidden" id="username" value="<%= user.name %>">
    </div>

    <main class='container mx-auto px-4 mt-28 md:mt-16' id='app' v-cloak>
        <img src="/picture/<%= user._id %>" height="30px" class='rounded-full h-10 inline-block shadow'>
        <h1 class="text-base">
            @<%= user.name %>
            <%- user.admin ? '<span class="iconify inline-block mr-1 text-indigo-600" data-icon="uil:shield-check" data-inline="true"></span>' :
                user.verified ? '<span class="iconify inline-block mr-1 text-indigo-600" data-icon="uil:check-circle" data-inline="true"></span>' : '' %>
        </h1>

        <% if(loggedInUser) { %>
            <button data-user='<%= user.name %>' id='follow'
                class="group relative inline-block py-2 px-4 border border-transparent text-sm leading-5 font-medium rounded-md text-white
                <%= Array.isArray(user.followers) && loggedInUser._id ? (user.followers.includes(loggedInUser._id.toString()) ? 'bg-gray-500 hover:bg-gray-500' : 'bg-indigo-500 hover:bg-indigo-500') : 'bg-indigo-500 hover:bg-indigo-500' %> transition duration-150 ease-in-out">
                <span class="iconify inline-block mr-1" data-icon="uil:user-plus" data-inline="true"></span>
                <span class='inline-block' id='follow-text'>
                    <%= Array.isArray(user.followers) && loggedInUser._id ? (user.followers.includes(loggedInUser._id.toString()) ? 'Unfollow' : 'Follow') : 'Follow' %>
                </span>
            </button>
        <% } %>

        <p class="text-gray-700">
            <a :href='`/users/${user}/followers`'>
                <span id='follower-count'><%= Array.isArray(user.followers) ? user.followers.length : 0 %></span> followers
            </a> |
            <a :href='`/users/${user}/following`'>
                <span id='following-count'><%= Array.isArray(user.following) ? user.following.length : 0 %></span> following
            </a>
        </p>

        <p class="text-gray-700 italic">id: <%= user._id %></p>

        <post v-for="post in posts" v-bind:key="post._id" v-bind:post="post" v-bind:logged-in-user-id="loggedInUserID"></post>

        <button v-if='!last' @click="loadMore()" href="/login"
            class="max-w-2xl w-full mx-auto flex items-center justify-center mb-5 py-3 border border-transparent text-base font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 md:text-lg transition duration-150 ease-in-out">
            Load more
        </button>
    </main>
</body>

<%- include('../partials/scripts.ejs'); %>
<script src="/assets/js/love.js"></script>
<script type="module">
    import Post from "../assets/js/components/post.js";

    console.log('user script loaded');

    const user = document.getElementById('username').value;
    const loggedInUserIDInput = document.getElementById('loggedInUserID');
    const loggedInUserID = loggedInUserIDInput ? loggedInUserIDInput.value : null;

    const urlParams = new URLSearchParams(window.location.search);
    const onePost = urlParams.get('post');

    const app = new Vue({
        el: '#app',
        components: { Post },
        data: {
            page: 1,
            last: false,
            posts: [],
            loggedInUserID,
            user
        },
        async mounted() {
            if (onePost) {
                console.log('loading one post');
                this.page = 0;
                const res = await fetch(`/api/posts/${onePost}`);
                const data = await res.json();
                data.highlight = true;
                Vue.set(this.posts, 0, data);
            } else {
                console.log('loading all posts');
                const res = await fetch(`/api/users/${user}/posts`);
                const data = await res.json();
                this.posts = data.posts;
                this.last = data.last;
            }
        },
        methods: {
            loadMore: async function () {
                if (this.page == 0) {
                    const newURL = location.href.split("?")[0];
                    window.history.pushState('object', document.title, newURL);
                    this.posts = []; // remove all posts if viewing a specific post
                }
                this.page++;
                const res = await fetch(`/api/users/${user}/posts?page=${this.page}`);
                const data = await res.json();
                this.posts = this.posts.concat(data.posts);
                this.last = data.last;
            },
            lovePost: async function (id) {
                love(id, (newLoves) => {
                    const post = this.posts.find(i => i._id == id);
                    if (post) post.loves = newLoves;
                });
            }
        }
    });

    const followButton = document.querySelector('#follow');
    if (followButton) {
        followButton.addEventListener('click', () => follow(followButton.dataset.user));
    }

    async function follow(user) {
        console.log(`gonna follow ${user}`);
        const followres = await fetch(`/users/${user}/follow`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
        });
        const followjson = await followres.json();
        console.log(followjson);

        if (followjson.ok) {
            document.getElementById('follower-count').innerText = followjson.followers || 0;
            document.getElementById('following-count').innerText = followjson.following || 0;

            if (followjson.action == 'follow') {
                document.getElementById('follow-text').innerText = `Unfollow`;
                followButton.classList.remove('bg-indigo-500', 'hover:bg-indigo-500');
                followButton.classList.add('bg-gray-500', 'hover:bg-gray-500');
            }

            if (followjson.action == 'unfollow') {
                document.getElementById('follow-text').innerText = `Follow`;
                followButton.classList.remove('bg-gray-500', 'hover:bg-gray-500');
                followButton.classList.add('bg-indigo-500', 'hover:bg-indigo-500');
            }
        }

        if (followjson.error) {
            Swal.fire({
                icon: 'error',
                title: 'Failed to follow',
                text: followjson.error,
                footer: '<a href="https://github.com/jeffalo/wasteof.money/issues" target="_blank" rel="noopener">Report issues</a>'
            });
        }
    }
</script>

</html>
